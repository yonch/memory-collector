
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://unvariance.github.io/collector/pipeline-implementation/">
      
      
        <link rel="prev" href="../noise-generators/">
      
      
        <link rel="next" href="../resctrl-guide/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Pipeline Implementation Guide - Unvariance collector docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pipeline-implementation-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Unvariance collector docs" class="md-header__button md-logo" aria-label="Unvariance collector docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Unvariance collector docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pipeline Implementation Guide
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Unvariance collector docs" class="md-nav__button md-logo" aria-label="Unvariance collector docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Unvariance collector docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Collector Benchmark Results
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../collection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Collector Telemetry Strategy
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RMID Tracking Design
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../devlog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Devlog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../noise-generators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Synthetic Noise Generators
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Pipeline Implementation Guide
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Pipeline Implementation Guide
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#channel-communication-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Channel Communication Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Channel Communication Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#channel-types-and-creation" class="md-nav__link">
    <span class="md-ellipsis">
      Channel Types and Creation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mpsc-channels-for-pipeline-connectivity" class="md-nav__link">
    <span class="md-ellipsis">
      MPSC Channels for Pipeline Connectivity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backpressure-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Backpressure Handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backpressure Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rate-limited-console-logging" class="md-nav__link">
    <span class="md-ellipsis">
      Rate-Limited Console Logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling-and-supervision" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling and Supervision
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling and Supervision">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#error-coordination-with-supervision-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Error Coordination with Supervision Tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling Strategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#graceful-shutdown-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Graceful Shutdown Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Graceful Shutdown Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shutdown-coordination-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Shutdown Coordination Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#signal-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Signal Handling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-design-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Key Design Principles
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../resctrl-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux Resource Control (resctrl) Operations Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../s3-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    S3 Testing for Memory Collector
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_1" >
        
          
          <label class="md-nav__link" for="__nav_10_1" id="__nav_10_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Decisions
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_1">
            <span class="md-nav__icon md-icon"></span>
            Decisions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/decisions/2024-12-21-container-notifications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024-12-21: Notifications for container lifecycle events
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/decisions/2025-01-02-aws-test-runners/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025-01-02: AWS test runners
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/decisions/2025-02-18-getting-cmt-measurements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025-02-18: Collecting Intel CMT Measurements
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Ci
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Ci
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ci/aws-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWS Setup for CI Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#channel-communication-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Channel Communication Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Channel Communication Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#channel-types-and-creation" class="md-nav__link">
    <span class="md-ellipsis">
      Channel Types and Creation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mpsc-channels-for-pipeline-connectivity" class="md-nav__link">
    <span class="md-ellipsis">
      MPSC Channels for Pipeline Connectivity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backpressure-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Backpressure Handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backpressure Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rate-limited-console-logging" class="md-nav__link">
    <span class="md-ellipsis">
      Rate-Limited Console Logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling-and-supervision" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling and Supervision
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling and Supervision">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#error-coordination-with-supervision-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Error Coordination with Supervision Tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling Strategy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#graceful-shutdown-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Graceful Shutdown Patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Graceful Shutdown Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shutdown-coordination-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Shutdown Coordination Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#signal-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Signal Handling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-design-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Key Design Principles
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="pipeline-implementation-guide">Pipeline Implementation Guide</h1>
<p>This document describes how the collector implements streaming data pipelines using Rust's async ecosystem, focusing on channel communication, error handling, and graceful shutdown patterns.</p>
<h2 id="channel-communication-patterns">Channel Communication Patterns</h2>
<h3 id="channel-types-and-creation">Channel Types and Creation</h3>
<p>The pipeline creates and configures all channels, transferring them to individual stages rather than having stages create their own channels. The pipeline drops its references to senders so that receiver stages can detect when all senders are closed, and transfers receiver ownership to the consuming stages.</p>
<p><strong>Bounded channels provide the foundation for backpressure-aware streaming pipelines</strong>. We use bounded channels to prevent memory exhaustion under high load conditions, with the channel itself serving as the buffer mechanism.</p>
<h3 id="mpsc-channels-for-pipeline-connectivity">MPSC Channels for Pipeline Connectivity</h3>
<p><strong>MPSC (Multi-Producer, Single-Consumer) channels</strong> are our primary choice for connecting pipeline stages. While we typically use single producers, MPSC is the standard Tokio implementation we rely on. For system measurement data, we typically use a capacity of 1000-10000 messages based on data frequency and processing latency requirements.</p>
<h3 id="backpressure-handling">Backpressure Handling</h3>
<p><strong>Backpressure handling becomes critical when processing high-frequency eBPF measurements</strong>. Our strategy focuses on time slot dropping with logging:</p>
<ul>
<li><strong>Drop time slots</strong> when downstream stages cannot keep up</li>
<li><strong>Log the number of dropped time slots</strong> and report counts every second</li>
<li><strong>Avoid blocking</strong> to ensure forward progress</li>
</ul>
<h4 id="rate-limited-console-logging">Rate-Limited Console Logging</h4>
<p>Since we process thousands of time slots per second, we need rate limiting mechanisms to avoid console spam. The pattern is for each processing loop to maintain its own drop counter and use <code>tokio::select!</code> with a timer for periodic logging.</p>
<pre><code class="language-rust">use tokio::time::{interval, Duration};

async fn processing_loop_with_drop_logging(
    mut input_rx: mpsc::Receiver&lt;TimeslotData&gt;,
    output_tx: mpsc::Sender&lt;ProcessedData&gt;,
) -&gt; Result&lt;(), ProcessingError&gt; {
    let mut drop_count = 0u64;
    let mut log_timer = interval(Duration::from_secs(1));

    loop {
        tokio::select! {
            result = input_rx.recv() =&gt; {
                match result {
                    Some(timeslot) =&gt; {
                        let processed = process_timeslot(timeslot).await?;

                        // Try to send without blocking
                        match output_tx.try_send(processed) {
                            Ok(_) =&gt; {
                                // Successfully sent
                            }
                            Err(mpsc::error::TrySendError::Full(_)) =&gt; {
                                // Channel full - drop time slot
                                drop_count += 1;
                                metrics::counter!(&quot;timeslots_dropped&quot;).increment(1);
                            }
                            Err(mpsc::error::TrySendError::Closed(_)) =&gt; {
                                // Receiver dropped - pipeline shutting down
                                break;
                            }
                        }
                    }
                    None =&gt; {
                        // Input channel closed - pipeline shutting down
                        break;
                    }
                }
            }

            _ = log_timer.tick() =&gt; {
                // Log drops every second
                if drop_count &gt; 0 {
                    log::warn!(&quot;Dropped {} time slots in last second&quot;, drop_count);
                    drop_count = 0;
                }
            }
        }
    }

    Ok(())
}
</code></pre>
<h2 id="error-handling-and-supervision">Error Handling and Supervision</h2>
<h3 id="error-coordination-with-supervision-tasks">Error Coordination with Supervision Tasks</h3>
<p><strong>Error channels communicate failures to monitoring and supervision tasks</strong> rather than between processing stages directly. Each pipeline stage receives an error sender to report failures to a centralized monitoring task.</p>
<pre><code class="language-rust">use tokio_util::sync::CancellationToken;
use tokio::sync::mpsc;

struct PipelineStage {
    error_tx: mpsc::UnboundedSender&lt;PipelineError&gt;,
    shutdown_token: CancellationToken,
}

impl PipelineStage {
    async fn run(&amp;self) -&gt; Result&lt;(), PipelineError&gt; {
        let shutdown_token = self.shutdown_token.clone();

        tokio::select! {
            _ = shutdown_token.cancelled() =&gt; {
                tracing::info!(&quot;Stage shutting down gracefully&quot;);
                Ok(())
            }
            result = self.execute_stage_logic() =&gt; {
                match result {
                    Ok(_) =&gt; Ok(()),
                    Err(e) =&gt; {
                        tracing::error!(&quot;Stage failed: {:?}&quot;, e);
                        self.error_tx.send(e.clone()).ok();
                        Err(e)
                    }
                }
            }
        }
    }
}
</code></pre>
<h3 id="error-handling-strategy">Error Handling Strategy</h3>
<p><strong>Errors in our system tend to be fatal</strong>. Rather than implementing complex restart strategies, we:</p>
<ul>
<li>Report errors to the supervision task</li>
<li>Supervision task triggers graceful shutdown with timeout</li>
<li>Force shutdown if graceful shutdown timeout expires</li>
<li>Allow the collector pod to restart after shutdown</li>
<li>Log comprehensive error information for debugging</li>
</ul>
<p>Unlike signal-based shutdown where we can rely on Kubernetes' grace period, error-triggered shutdowns require their own timeout mechanism since Kubernetes isn't initiating the shutdown.</p>
<pre><code class="language-rust">use tokio::time::{timeout, Duration};

async fn supervision_task(
    mut error_rx: mpsc::UnboundedReceiver&lt;PipelineError&gt;,
    shutdown_token: CancellationToken,
    graceful_shutdown_timeout: Duration,
) -&gt; Result&lt;(), SupervisionError&gt; {
    while let Some(error) = error_rx.recv().await {
        tracing::error!(&quot;Pipeline error received: {:?}&quot;, error);

        // Trigger graceful shutdown
        tracing::info!(&quot;Initiating graceful shutdown due to error&quot;);
        shutdown_token.cancel();

        // Wait for graceful shutdown with timeout
        match timeout(graceful_shutdown_timeout, wait_for_pipeline_shutdown()).await {
            Ok(_) =&gt; {
                tracing::info!(&quot;Graceful shutdown completed successfully&quot;);
                break;
            }
            Err(_) =&gt; {
                tracing::error!(&quot;Graceful shutdown timeout expired, forcing shutdown&quot;);
                // Force shutdown mechanisms here (e.g., std::process::exit)
                std::process::exit(1);
            }
        }
    }

    Ok(())
}
</code></pre>
<p>This approach attempts graceful shutdown first with a reasonable timeout, then falls back to forced shutdown to prevent hanging on fatal errors.</p>
<h2 id="graceful-shutdown-patterns">Graceful Shutdown Patterns</h2>
<h3 id="shutdown-coordination-strategy">Shutdown Coordination Strategy</h3>
<p><strong>Cancellation tokens coordinate shutdown across pipeline stages</strong>. However, stages that only read from channels don't need to monitor the cancellation token directly—they should drain their inputs until no more data is available, then close their outputs and terminate.</p>
<p><strong>Only stages that don't follow this pattern need explicit shutdown signaling</strong>, such as stages reading from eBPF rings that need to stop reading and perform cleanup.</p>
<pre><code class="language-rust">use tokio::signal;
use tokio_util::sync::CancellationToken;

async fn channel_draining_stage(
    mut input_rx: mpsc::Receiver&lt;MeasurementData&gt;,
    output_tx: mpsc::Sender&lt;ProcessedData&gt;,
) -&gt; Result&lt;(), ProcessingError&gt; {
    // Drain input until channel closes
    while let Some(measurement) = input_rx.recv().await {
        let processed = process_measurement(measurement).await?;

        // If output channel is closed, we're shutting down
        if output_tx.send(processed).await.is_err() {
            break;
        }
    }

    // Close output channel to signal downstream stages
    drop(output_tx);
    Ok(())
}

async fn ebpf_reading_stage(
    shutdown_token: CancellationToken,
    output_tx: mpsc::Sender&lt;MeasurementData&gt;,
) -&gt; Result&lt;(), ProcessingError&gt; {
    let mut ebpf_reader = EbpfReader::new().await?;

    tokio::select! {
        _ = shutdown_token.cancelled() =&gt; {
            tracing::info!(&quot;eBPF stage shutting down&quot;);
            ebpf_reader.cleanup().await?;
            drop(output_tx);
            Ok(())
        }
        result = ebpf_reader.read_loop(&amp;output_tx) =&gt; {
            result
        }
    }
}
</code></pre>
<h3 id="signal-handling">Signal Handling</h3>
<p><strong>Signal handling with proper cleanup coordination</strong> ensures data integrity during system shutdown. We use an isolated signal monitor task that listens for shutdown signals and coordinates with the cancellation token.</p>
<pre><code class="language-rust">use tokio::signal;
use tokio_util::sync::CancellationToken;

struct ProductionPipeline {
    shutdown_token: CancellationToken,
}

impl ProductionPipeline {
    async fn spawn_signal_monitor(&amp;self) {
        let shutdown_token = self.shutdown_token.clone();

        tokio::spawn(async move {
            let mut sigterm = signal::unix::signal(signal::unix::SignalKind::terminate()).unwrap();
            let mut sigint = signal::unix::signal(signal::unix::SignalKind::interrupt()).unwrap();

            tokio::select! {
                _ = sigterm.recv() =&gt; {
                    tracing::info!(&quot;Received SIGTERM, initiating graceful shutdown&quot;);
                    shutdown_token.cancel();
                }
                _ = sigint.recv() =&gt; {
                    tracing::info!(&quot;Received SIGINT, initiating graceful shutdown&quot;);
                    shutdown_token.cancel();
                }
                _ = shutdown_token.cancelled() =&gt; {
                    tracing::info!(&quot;Shutdown token cancelled, signal monitor terminating&quot;);
                }
            }
        });
    }

    async fn run_pipeline(&amp;self) -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
        // Start signal monitoring
        self.spawn_signal_monitor().await;

        // Start pipeline stages
        self.start_all_stages().await?;

        // Wait for shutdown signal
        self.shutdown_token.cancelled().await;

        // Initiate graceful shutdown
        self.graceful_shutdown().await?;

        Ok(())
    }

    async fn graceful_shutdown(&amp;self) -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
        tracing::info!(&quot;Initiating graceful shutdown...&quot;);

        // Signal shutdown to stages that need explicit notification
        self.shutdown_token.cancel();

        // Wait for all stages to complete (no timeout - let Kubernetes handle this)
        self.wait_for_all_stages().await?;

        tracing::info!(&quot;Graceful shutdown complete&quot;);
        Ok(())
    }
}
</code></pre>
<h2 id="key-design-principles">Key Design Principles</h2>
<ol>
<li><strong>Pipeline creates channels</strong>: Stages receive pre-configured channels rather than creating their own</li>
<li><strong>Bounded channels prevent memory exhaustion</strong>: Use appropriate buffer sizes based on data frequency</li>
<li><strong>Drop time slots under backpressure</strong>: Maintain forward progress with rate-limited logging</li>
<li><strong>Cascade shutdowns through channel closure</strong>: Most stages can shut down by draining inputs</li>
<li><strong>Explicit shutdown signaling only when needed</strong>: Reserve cancellation tokens for stages that require cleanup</li>
<li><strong>Leverage Kubernetes grace periods</strong>: Allow natural shutdown timing rather than imposing artificial timeouts</li>
<li><strong>Isolated signal monitoring</strong>: Use dedicated task for signal handling with cancellation token coordination</li>
</ol>
<p>This architecture provides robust, high-performance streaming pipelines that handle millions of measurements per second while maintaining operational reliability and clear error reporting.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>