
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://unvariance.github.io/collector/architecture/decisions/2025-01-02-aws-test-runners/">
      
      
        <link rel="prev" href="../2024-12-21-container-notifications/">
      
      
        <link rel="next" href="../2025-02-18-getting-cmt-measurements/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>2025-01-02: AWS test runners - Unvariance collector docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2025-01-02-aws-test-runners" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Unvariance collector docs" class="md-header__button md-logo" aria-label="Unvariance collector docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Unvariance collector docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2025-01-02: AWS test runners
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Unvariance collector docs" class="md-nav__button md-logo" aria-label="Unvariance collector docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Unvariance collector docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Collector Benchmark Results
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../collection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Collector Telemetry Strategy
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RMID Tracking Design
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../devlog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Devlog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../noise-generators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Synthetic Noise Generators
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline-implementation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline Implementation Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../resctrl-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux Resource Control (resctrl) Operations Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../s3-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    S3 Testing for Memory Collector
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_1" checked>
        
          
          <label class="md-nav__link" for="__nav_10_1" id="__nav_10_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Decisions
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_1">
            <span class="md-nav__icon md-icon"></span>
            Decisions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-12-21-container-notifications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024-12-21: Notifications for container lifecycle events
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    2025-01-02: AWS test runners
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    2025-01-02: AWS test runners
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#status" class="md-nav__link">
    <span class="md-ellipsis">
      Status
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#options-considered-ec2-based" class="md-nav__link">
    <span class="md-ellipsis">
      Options considered - EC2 based
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Options considered - EC2 based">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-pros-and-cons" class="md-nav__link">
    <span class="md-ellipsis">
      Common pros and cons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-ec2-with-user-data" class="md-nav__link">
    <span class="md-ellipsis">
      AWS EC2 with User Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-ec2-with-a-github-self-hosted-runner" class="md-nav__link">
    <span class="md-ellipsis">
      AWS EC2 with a GitHub Self-Hosted Runner
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#options-considered-kubernetes-based" class="md-nav__link">
    <span class="md-ellipsis">
      Options considered - Kubernetes based
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Options considered - Kubernetes based">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-pros-and-cons_1" class="md-nav__link">
    <span class="md-ellipsis">
      Common pros and cons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spin-up-a-kubernetes-cluster-and-run-the-tests-in-a-pod" class="md-nav__link">
    <span class="md-ellipsis">
      Spin up a Kubernetes cluster and run the tests in a pod
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintain-a-persistent-kubernetes-cluster-with-actions-runner-controller" class="md-nav__link">
    <span class="md-ellipsis">
      Maintain a persistent Kubernetes cluster with actions-runner-controller
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicatedcom-compatibility-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      Replicated.com Compatibility Matrix
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decision" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Consequences">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#positive" class="md-nav__link">
    <span class="md-ellipsis">
      Positive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#negative" class="md-nav__link">
    <span class="md-ellipsis">
      Negative
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risks" class="md-nav__link">
    <span class="md-ellipsis">
      Risks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2025-02-18-getting-cmt-measurements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025-02-18: Collecting Intel CMT Measurements
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Ci
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Ci
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ci/aws-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWS Setup for CI Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#status" class="md-nav__link">
    <span class="md-ellipsis">
      Status
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#options-considered-ec2-based" class="md-nav__link">
    <span class="md-ellipsis">
      Options considered - EC2 based
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Options considered - EC2 based">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-pros-and-cons" class="md-nav__link">
    <span class="md-ellipsis">
      Common pros and cons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-ec2-with-user-data" class="md-nav__link">
    <span class="md-ellipsis">
      AWS EC2 with User Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aws-ec2-with-a-github-self-hosted-runner" class="md-nav__link">
    <span class="md-ellipsis">
      AWS EC2 with a GitHub Self-Hosted Runner
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#options-considered-kubernetes-based" class="md-nav__link">
    <span class="md-ellipsis">
      Options considered - Kubernetes based
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Options considered - Kubernetes based">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-pros-and-cons_1" class="md-nav__link">
    <span class="md-ellipsis">
      Common pros and cons
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spin-up-a-kubernetes-cluster-and-run-the-tests-in-a-pod" class="md-nav__link">
    <span class="md-ellipsis">
      Spin up a Kubernetes cluster and run the tests in a pod
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintain-a-persistent-kubernetes-cluster-with-actions-runner-controller" class="md-nav__link">
    <span class="md-ellipsis">
      Maintain a persistent Kubernetes cluster with actions-runner-controller
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicatedcom-compatibility-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      Replicated.com Compatibility Matrix
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decision" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Consequences">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#positive" class="md-nav__link">
    <span class="md-ellipsis">
      Positive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#negative" class="md-nav__link">
    <span class="md-ellipsis">
      Negative
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risks" class="md-nav__link">
    <span class="md-ellipsis">
      Risks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="2025-01-02-aws-test-runners">2025-01-02: AWS test runners</h1>
<h2 id="status">Status</h2>
<p>Accepted</p>
<h2 id="context">Context</h2>
<p>We'd like to run some tests on AWS to check the availability of PMC (Performance Monitoring Counters) and Linux resctrl on different instance types. To do this, we'll want an automated way to run tests on different instance types.</p>
<p>As of writing, the main check will be <code>cpi-count</code>, which checks the availability of cycles and instructions, and compares the results of <code>go-perf</code> and <code>perf</code> to sanity-check the results. </p>
<p>In the future, we'll want to add more tests and similarly run them on different instance types. For example:</p>
<ul>
<li>Checking other counters than cycles and instructions (e.g., LLCMisses)</li>
<li>Checking the availability of <code>resctrl</code> in Linux</li>
<li>Verifying <code>resctrl</code> is able to control memory bandwidth and cache allocation</li>
</ul>
<p>This decision is about individual, relatively simple checks that run on a single instance. Tests that require complex workloads (e.g., DeathStarBench) are out of scope for this decision.</p>
<h2 id="options-considered-ec2-based">Options considered - EC2 based</h2>
<h3 id="common-pros-and-cons">Common pros and cons</h3>
<p>Pros:</p>
<ul>
<li>Easy to run multiple instances</li>
<li>Gives control over the operating system and AMI, if we need that control in the future.</li>
<li>Few components running on the VM, so this is less noisy and more conducive to benchmarking.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Only works on AWS. Will require adaptation for other clouds.</li>
</ul>
<h3 id="aws-ec2-with-user-data">AWS EC2 with User Data</h3>
<p>This is the strawman: spin up an EC2 instance, install the necessary tools, run the tests, and then tear down the instance. User Data is a way to run commands when the instance is first launched.</p>
<p>Additional pros:</p>
<ul>
<li>None</li>
</ul>
<p>Additional cons:</p>
<ul>
<li>There is no good way to get results out of the instance.</li>
<li>It is hard to check when tests are done.</li>
</ul>
<h3 id="aws-ec2-with-a-github-self-hosted-runner">AWS EC2 with a GitHub Self-Hosted Runner</h3>
<p>This spins up an EC2 instance that runs a GitHub Actions runner. The runner is labeled specifically for the test that spins it up. The Action then runs the test workflow on the runner it just spun up. At the end of the test, the workflow tears down the runner.</p>
<p>Additional pros:</p>
<ul>
<li>Integrated well with GitHub Actions: natively extracts results and continues the workflow when the test is done.</li>
</ul>
<p>Additional cons:</p>
<ul>
<li>More complex than EC2 with User Data (but solves that approach's problems).</li>
</ul>
<h2 id="options-considered-kubernetes-based">Options considered - Kubernetes based</h2>
<h3 id="common-pros-and-cons_1">Common pros and cons</h3>
<p>Pros:</p>
<ul>
<li>We might be able to reuse this infrastructure for benchmarks with <em>complex</em> Kubernetes workloads.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Complex. Need to set up a Kubernetes cluster and all its tooling.</li>
<li>Less control over the operating system and AMI.</li>
<li>Kubernetes has more components running on the Node (e.g., kubelet) that introduce noise, so this approach is less conducive to benchmarking.</li>
</ul>
<h3 id="spin-up-a-kubernetes-cluster-and-run-the-tests-in-a-pod">Spin up a Kubernetes cluster and run the tests in a pod</h3>
<p>This is the approach the Cilium uses for its <a href="https://github.com/cilium/cilium/blob/main/.github/workflows/conformance-eks.yaml#L1">EKS conformance tests.</a>.</p>
<p>Additional pros:</p>
<ul>
<li>Easy to check for completion and extract results (with <code>kubectl</code>).</li>
</ul>
<p>Additional cons:</p>
<ul>
<li>More components to set up and tear down (the Kubernetes control plane) which increases the time it takes to run tests and the cost of running tests.</li>
<li>Need to write the functionality to extract results ourselves.</li>
</ul>
<h3 id="maintain-a-persistent-kubernetes-cluster-with-actions-runner-controller">Maintain a persistent Kubernetes cluster with <code>actions-runner-controller</code></h3>
<p>following GitHub's <a href="https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners/autoscaling-with-self-hosted-runners">"Autoscaling with self-hosted runners"</a>:</p>
<ul>
<li>Run a Kubernetes cluster on one of the cloud providers</li>
<li>Use GitHub Actions to trigger tests</li>
<li>Tests run self hosted on the Kubernetes cluster. The <a href="https://github.com/actions/actions-runner-controller">actions-runner-controller</a> seems to be the official controller for this.</li>
<li>Each test that requires a specific node type will trigger a runner that only runs on that node type</li>
</ul>
<p>I believe we can add a nodeSelector <a href="https://github.com/actions/actions-runner-controller/blob/96d1bbcf2fa961e7f64fad45ea8903b741cb3e16/charts/gha-runner-scale-set/templates/autoscalingrunnerset.yaml#L112">in the AutoscalingRunnerSet</a> from the values.yaml when deploying the controller (under <a href="https://github.com/actions/actions-runner-controller/blob/96d1bbcf2fa961e7f64fad45ea8903b741cb3e16/charts/gha-runner-scale-set/values.yaml#L189">template.spec</a>). So this might require a controller deployment per node type.</p>
<p>Additional pros:</p>
<ul>
<li>Very little spin-up and tear-down code, as the controller handles the scaling. This reulsts in simpler Actions, and more reliable cleanup.</li>
<li>Tests run on GitHub Runners, so they extract results natively.</li>
<li>We can spin up similar clusters on other clouds, and reuse the exact same Actions to run the tests on other clouds' instance types.</li>
</ul>
<p>Additional cons:</p>
<ul>
<li>Cluster is relatively complex: needs to anticipate all instance types we want to test on, and add controllers for each. This can be implemented with for loops in a helm chart, but still adds complexity.</li>
<li>Cluster would be persistent, so it has ongoing cost, regardless of whether tests are running or not.</li>
<li>The cluster would be maintained separately from the tests, so it might be hard to keep them in sync.</li>
</ul>
<h3 id="replicatedcom-compatibility-matrix">Replicated.com Compatibility Matrix</h3>
<p>It is a service that spins up full Kubernetes clusters for testing, and bills by usage.</p>
<p>Additional pros:</p>
<ul>
<li>Easy to spin up and tear down clusters.</li>
<li>Support for AWS, GCP, Azure, OCI, as well as Openshift, RKE2, and k3s.</li>
<li>Might have credits for open source projects (at least with Openshift)</li>
</ul>
<p>Additional cons:</p>
<ul>
<li>Needs Kubernetes tooling installed (which complicates the Github Action)</li>
<li>Markup over using the clouds directly (although it is small)</li>
<li>No spot instance support</li>
</ul>
<h2 id="decision">Decision</h2>
<p>We'll use the EC2 + GitHub Actions Runner approach, because it is the simplest way that returns results and is easy to check for completion.</p>
<h2 id="consequences">Consequences</h2>
<h3 id="positive">Positive</h3>
<ul>
<li>Can write the entire test as a GitHub Action.</li>
<li>The same approach can be used for benchmarking.</li>
<li>Can use AWS credits to run tests.</li>
</ul>
<h3 id="negative">Negative</h3>
<ul>
<li>We are currently just enabling AWS. To run on other clouds, the setup and cleanup would need to be updated.</li>
</ul>
<h3 id="risks">Risks</h3>
<ul>
<li>Making cleanup bulletproof would require iteration, which could lead to orphaned runners and their associated costs in the interim.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>