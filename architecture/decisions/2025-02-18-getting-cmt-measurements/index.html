
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://unvariance.github.io/collector/architecture/decisions/2025-02-18-getting-cmt-measurements/">
      
      
        <link rel="prev" href="../2025-01-02-aws-test-runners/">
      
      
        <link rel="next" href="../../../ci/aws-setup/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>2025-02-18: Collecting Intel CMT Measurements - Unvariance collector docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2025-02-18-collecting-intel-cmt-measurements" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Unvariance collector docs" class="md-header__button md-logo" aria-label="Unvariance collector docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Unvariance collector docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2025-02-18: Collecting Intel CMT Measurements
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Unvariance collector docs" class="md-nav__button md-logo" aria-label="Unvariance collector docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Unvariance collector docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Collector Benchmark Results
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../collection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Collector Telemetry Strategy
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RMID Tracking Design
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../devlog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Devlog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../noise-generators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Synthetic Noise Generators
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline-implementation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline Implementation Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../resctrl-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linux Resource Control (resctrl) Operations Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../s3-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    S3 Testing for Memory Collector
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_1" checked>
        
          
          <label class="md-nav__link" for="__nav_10_1" id="__nav_10_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Decisions
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_1">
            <span class="md-nav__icon md-icon"></span>
            Decisions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-12-21-container-notifications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024-12-21: Notifications for container lifecycle events
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2025-01-02-aws-test-runners/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025-01-02: AWS test runners
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    2025-02-18: Collecting Intel CMT Measurements
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    2025-02-18: Collecting Intel CMT Measurements
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decision" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rationale" class="md-nav__link">
    <span class="md-ellipsis">
      Rationale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#status" class="md-nav__link">
    <span class="md-ellipsis">
      Status
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-a-intel-cmt-cat-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix A: intel-cmt-cat summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix A: intel-cmt-cat summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mentions-of-using-the-perf-command-line" class="md-nav__link">
    <span class="md-ellipsis">
      Mentions of using the perf command line
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-b-a-journey-through-intel-cmt-cat" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix B: A journey through intel-cmt-cat
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Ci
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Ci
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ci/aws-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AWS Setup for CI Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decision" class="md-nav__link">
    <span class="md-ellipsis">
      Decision
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rationale" class="md-nav__link">
    <span class="md-ellipsis">
      Rationale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consequences" class="md-nav__link">
    <span class="md-ellipsis">
      Consequences
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#status" class="md-nav__link">
    <span class="md-ellipsis">
      Status
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-a-intel-cmt-cat-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix A: intel-cmt-cat summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Appendix A: intel-cmt-cat summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mentions-of-using-the-perf-command-line" class="md-nav__link">
    <span class="md-ellipsis">
      Mentions of using the perf command line
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-b-a-journey-through-intel-cmt-cat" class="md-nav__link">
    <span class="md-ellipsis">
      Appendix B: A journey through intel-cmt-cat
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="2025-02-18-collecting-intel-cmt-measurements">2025-02-18: Collecting Intel CMT Measurements</h1>
<h2 id="context">Context</h2>
<p>We need to collect Intel CMT (Cache Monitoring Technology) measurements at millisecond granularity for containers in a cloud-native environment. </p>
<h2 id="decision">Decision</h2>
<p><strong>We will build a kernel module that interacts directly with Intel RDT MSRs (Model Specific Registers) to configure and read CMT measurements.</strong></p>
<h2 id="rationale">Rationale</h2>
<p>We considered three approaches for collecting CMT measurements:</p>
<ol>
<li>
<p><strong>Using Linux perf counters</strong>: After investigating the Intel CMT-CAT repository and relevant Linux kernel code, we found that although the Intel software repository seemed to support perf counters for CMT, the Linux kernel did not actually implement this. Therefore, using perf was not a viable option.</p>
</li>
<li>
<p><strong>Using the resctrl filesystem interface</strong>: The Linux kernel's resctrl subsystem provides a filesystem-based interface for configuring Intel RDT and reading measurements. However, this approach has several drawbacks:</p>
</li>
<li>Collecting measurements at millisecond granularity through the filesystem interface for all containers would be complex and potentially inefficient due to the overhead of system calls. </li>
<li>
<p>Resctrl is based on tasks and processes rather than containers. To use resctrl, we would need to build a system to monitor container lifecycle events and configure resctrl accordingly, which would add complexity and potential gaps in measurement.</p>
</li>
<li>
<p><strong>Building a kernel module to interact with MSRs directly</strong>: This approach offers several advantages:</p>
</li>
<li>By interacting with MSRs directly, the kernel module can read CMT information with very low overhead, without the layers of the filesystem interface.</li>
<li>The kernel module can probe container lifecycle tracepoints to allocate RMIDs (Resource Monitoring IDs) and assign them to containers automatically.</li>
<li>This approach enables a cloud-native solution that seamlessly measures containers as they are created.</li>
</ol>
<p>Given these considerations, we chose to build a kernel module that interacts with Intel RDT MSRs directly. This approach provides the best performance, flexibility, and compatibility with a cloud-native container environment.</p>
<h2 id="consequences">Consequences</h2>
<p>Building a kernel module for CMT measurement has the following consequences:</p>
<ul>
<li>We will need to maintain the kernel module code and ensure compatibility with different Linux kernel versions.</li>
<li>Users will need to load the kernel module to enable CMT measurement collection.</li>
<li>We will have tight integration with container lifecycle events, enabling seamless measurement of containers.</li>
<li>We can achieve low-overhead, millisecond-granularity measurement collection, meeting our performance requirements.</li>
</ul>
<h2 id="status">Status</h2>
<p>Accepted</p>
<h2 id="appendix-a-intel-cmt-cat-summary">Appendix A: intel-cmt-cat summary</h2>
<p>The <code>perf_monitoring.c</code> file:</p>
<ul>
<li>Checks if perf is available by checking if <code>/proc/sys/kernel/perf_event_paranoid</code> exists.</li>
<li>Checks if RDT exists by reading <code>/sys/devices/intel_cqm/type</code><ul>
<li>if it exists, its value (as integer) is the perf <code>type</code> field</li>
<li>traverses <code>/sys/devices/intel_cqm/events</code> for events <code>llc_occupancy</code>, <code>local_bytes</code>, <code>total_bytes</code></li>
<li>their value is parsed to get the <code>config</code> field of the perf struct</li>
<li>the same file with extension <code>.scale</code> is used to read a <code>double</code> scale</li>
</ul>
</li>
</ul>
<h3 id="mentions-of-using-the-perf-command-line">Mentions of using the perf command line</h3>
<p>Here are references from the web for monitoring RDT using perf. However note that we found that the patches discussed in these references were not present in the Linux kernel whose code we checked (6.13.2) and appear to have not been merged into the kernel originally.</p>
<p>A 2017 <a href="https://community.intel.com/t5/Software-Tuning-Performance/How-to-use-perf-event-open-function-exposed-by-linux-kernel-to/td-p/1144059">forum post</a> was able to view events with <code>perf stat</code> as events:</p>
<blockquote>
<p><code>intel_cqm/llc_occupancy , intel_cqm/llc_local_bytes/,intel_cqm_total_bytes/</code></p>
</blockquote>
<p>(the last value seems to have a typo replacing <code>/</code> with <code>_</code>)</p>
<p>An <a href="http://events17.linuxfoundation.org/sites/events/files/slides/LinuxConNA-kanaka.pdf">Intel/Kanaka Juvva presentation at LinuxCon'2015</a> shows per-application memory bandwidth monitoring with <code>perf</code> (slide 11):</p>
<blockquote>
<p>Two perf events are exported to userland
- LOCAL_BW
  - perf stat –e intel_cqm/llc_local_bw/ -a “my_application”
- TOTAL_BW
  - perf stat –e intel_cqm/llc_total_bw/ -a “my_application”</p>
</blockquote>
<p>A <a href="http://events17.linuxfoundation.org/sites/events/files/slides/CollaborationSummit2016-Slides-Kanaka_0.pdf">2016 Kanaka Juuva presentation</a>:
- further mentions LLC Occupancy
- shows memory bandwidth benchmark results
- shows more process-based CLI examples, by PID:</p>
<blockquote>
<ul>
<li>LLC_OCCUPANCY</li>
<li>perf stat –e intel_cqm/llc_occupancy/ -p “pid of my_application”</li>
<li>discusses cgroups-based measurements. This might have been before the switch from cgroup to resctrl.</li>
</ul>
</blockquote>
<h2 id="appendix-b-a-journey-through-intel-cmt-cat">Appendix B: A journey through intel-cmt-cat</h2>
<p>The <a href="https://github.com/intel/intel-cmt-cat">intel-cmt-cat</a> repo documentation suggests perf can read CMT data as well (<a href="https://github.com/intel/intel-cmt-cat?tab=readme-ov-file#software-compatibility">table 5 in README</a>).</p>
<p>In this section, we look into how intel-cmt-cat uses perf, and document its usage so we can support that alongside the other counters.</p>
<p>We start with the <code>pqos</code> CLI tool. Its command line parameters set up calls into the library in <code>lib/</code>:</p>
<ul>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/pqos/main.c#L1178"><code>main</code></a> calls <a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/pqos/monitor.c#L1141"><code>selfn_monitor_cores</code></a> on the <code>-m</code> command line option.</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/pqos/monitor.c#L1100"><code>parse_monitor_cores</code></a> parses the <code>-m</code> command line option.</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/pqos/monitor.c#L1024"><code>parse_monitor_group</code></a> parses a string from the command line to a list of cores or pids, and calls <code>grp_add</code> on each.</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/pqos/monitor.c#L815"><code>grp_add</code></a> allocates a <code>struct mon_group</code> called <code>new_grp</code> on the stack, then adds the core/pid/channel/etc. to the group using <code>grp_set_*</code>, and then appends it to a global variable <code>sel_monitor_group</code>.</li>
<li>later, <a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/pqos/main.c#L1508"><code>main</code> calls <code>monitor_setup</code></a></li>
<li><code>monitor_setup</code> calls the library API depending on the type of monitor. For cores, it <a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/pqos/monitor.c#L1434">calls <code>pqos_mon_start_cores</code></a>.</li>
</ul>
<p>Going into the library:</p>
<ul>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/api.c#L955"><code>pqos_mon_start_cores</code></a> calls <code>pqos_mon_start_cores_ext</code> (which also has an opt parameter)</li>
<li><code>pqos_mon_start_cores_ext</code> checks input validity and then makes an <a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/api.c#L1010"><code>API_CALL(mon_start_cores...)</code></a></li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/api.c#L265"><code>API_CALL</code></a> is a macro that accesses a virtual table of monitoring operations called <code>api</code> in <code>api.c</code>. <ul>
<li>This <code>api</code> variable is initialized in <a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/api.c#L184"><code>api_init</code></a> to either the OS interface or MSR interface (these are mentioned in the repo's README).</li>
<li>In the OS interface, the <code>mon_start_cores</code> function pointer is <a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/api.c#L227">initialized</a> to point to <code>os_mon_start_cores</code>.</li>
</ul>
</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/os_monitoring.c#L378"><code>os_mon_start_cores</code></a> validates the input, the available monitoring capabilities, and ensures the monitoring hadn't already started, and calls <code>os_mon_start_events</code>.</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/os_monitoring.c#L166"><code>os_mon_start_events</code></a>:<ul>
<li>runs <code>perf_mon_is_event_supported</code> on every event, and if so, calls <code>perf_mon_start</code>.</li>
<li>otherwise, checks <code>resctrl_mon_is_event_supported</code> and if so performs <code>resctrl_mon_start</code>.</li>
</ul>
</li>
</ul>
<p>Let's explore the flow that checks perf for supported events:</p>
<ul>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/perf_monitoring.c#L702"><code>perf_mon_is_event_supported</code></a> calls <code>get_supported_event</code>.</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/perf_monitoring.c#L159"><code>get_supported_event</code></a> looks up the event in a global <code>events_tab</code>.<ul>
<li>the first event in <code>events_tab</code> is <a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/perf_monitoring.c#L90"><code>llc_occupancy</code></a>.</li>
</ul>
</li>
</ul>
<p>Initialization of perf monitoring in <a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/perf_monitoring.c#L415"><code>perf_mon_init</code></a>:</p>
<ul>
<li>if <code>/proc/sys/kernel/perf_event_paranoid</code> exists, enables the PMU events (cycles, instructions, IPC, LLC misses, LLC references).</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/perf_monitoring.c#L227"><code>set_arch_event_attrs</code></a> sets the <code>attr</code> field on PMU events. The <code>attr</code> field is a <a href="https://github.com/torvalds/linux/blob/21266b8df5224c4f677acf9f353eecc9094731f0/include/uapi/linux/perf_event.h#L389"><code>struct perf_event_attr</code></a> (from the linux API).</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/perf_monitoring.c#L193"><code>set_mon_type</code></a> reads <code>/sys/devices/intel_cqm/type</code> as an integer into the global variable <code>os_mon_type</code>. This int is then used in the perf attr as its <code>type</code> field in <a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/perf_monitoring.c#L334"><code>set_rdt_event_attrs</code></a>.</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/667d224cfd689d3b3e63e58b3debc9e672eb87f4/lib/perf_monitoring.c#L350"><code>set_mon_events</code></a> then traverses the directory <code>/sys/devices/intel_cqm/events</code>. <ul>
<li>For each file, it tries to find an entry in <code>events_tab</code> whose <code>name</code> field is the same as the file name. </li>
<li>For every match, it calls <code>set_rdt_event_attrs</code>.</li>
</ul>
</li>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/3bae201f1900e529cff09c62aa7bc21b5ccaac75/lib/perf_monitoring.c#L281"><code>set_rdt_event_attrs</code></a><ul>
<li>reads the file</li>
<li>assumes the contents has a <code>=</code>, discards everything before the first <code>=</code> and parses the rest as an integer. this will be <code>attrs.config</code></li>
<li>reads another file filename+<code>.scale</code> suffix</li>
<li>parses it as a double. this will be the event's <code>scale</code></li>
</ul>
</li>
</ul>
<p>So far, we covered initialization and checking event availability. Now let's see how the library configures the kernel to start monitoring:</p>
<ul>
<li><a href="https://github.com/intel/intel-cmt-cat/blob/b9fd9f595f4cc1c404ba24f18da85951e4e9d922/lib/perf.c#L56"><code>perf_event_open</code></a> makes the syscall via <code>syscall(__NR_perf_event_open, attr, pid, cpu, group_fd, flags)</code></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>